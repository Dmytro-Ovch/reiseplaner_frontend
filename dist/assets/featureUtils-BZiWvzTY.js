import{bs as U,bt as D,bu as T,bv as w,bw as C,bx as h,by as y,aa as S,bz as z,bA as O,bB as g,bC as G,bD as Q,bE as P,b1 as H}from"./index-QkvpMIk7.js";const _="esri.widgets.Feature.support.featureUtils",I=()=>S.getLogger(_),B=/href=(""|'')/gi,V=/(\{([^{\r\n]+)\})/g,J=/'/g,E=/^\s*expression\//i,K=/(\n)/gi,W=/[\u00A0-\u9999<>&]/gim,X=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,Y=/^(?:mailto:|tel:)/,Z="relationships/",N=D("short-date-short-time");function Ne(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function Le({type:e,value:t,event:n}){try{return typeof t=="function"?t(n):await t}catch(r){return void I().error("error",`An error occurred when calling the "${e}" function`,{error:r,graphic:n.graphic,value:t})}}function xe(e=""){if(e)return!Y.test(e.trim().toLowerCase())}function ee(e){return!!e&&E.test(e)}function te(e,t){if(!t||!ee(t)||!e)return;const n=t.replace(E,"").toLowerCase();return e.find((({name:r})=>r.toLowerCase()===n))}function Ae(e,t){const n=te(t,e==null?void 0:e.fieldName);return n?n.title||null:e?e.label||e.fieldName:null}function ne(e,t){const n=t.get(e.toLowerCase());return`{${(n==null?void 0:n.fieldName)||e}}`}function re(e){return e.replaceAll(B,"")}function q(e,t){const n=F(t,e);return n?n.name:e}function Ce(e,t){return e&&e.map((n=>q(n,t)))}function F(e,t){return e&&typeof e.getField=="function"&&t?e.getField(t)??null:null}function R(e){return`${e}`.trim()}function Ee({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:a,fieldInfoMap:i}){return r?ie({formattedAttributes:t,template:ue(r,{...t,...a,...e},n),fieldInfoMap:i}):""}function ie({formattedAttributes:e,template:t,fieldInfoMap:n}){return R(re(g(g(t,(r=>ne(r,n))),e)))}function ae(e,t,n=!1){const r=t[e];if(typeof r=="string"){const i=(n?encodeURIComponent(r):r).replaceAll(J,"%27");t[e]=i}}function le(e,t=!1){const n={...e};return Object.keys(n).forEach((r=>ae(r,n,t))),n}function oe(e,t,n){const r=(t=R(t))&&t[0]!=="{";return g(e,le(n,r||!1))}function se(e,t){return e.replaceAll(V,((n,r,a)=>{const i=F(t,a);return i?`{${i.name}}`:r}))}function ue(e,t,n){const r=se(e,n);return r&&r.replaceAll(X,((a,i,l)=>oe(a,i||l,t)))}function fe(e,t){if(typeof e=="string"&&t&&t.dateFormat==null&&(t.places!=null||t.digitSeparator!=null)){const n=Number(e);if(!isNaN(n))return n}return e}function ce(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene"||e.type==="subtype-group"||e.type==="subtype-sublayer"||e.type==="sublayer")&&"when"in e}function de(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function k(e){return ce(e)&&de(e)}function Ze(e){return!(!(e&&typeof e=="object"&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"type"in e)||e.type!=="feature"&&e.type!=="subtype-group"&&e.type!=="subtype-sublayer"&&e.type!=="sublayer"||!("when"in e))&&(e.type==="subtype-sublayer"&&"parent"in e&&e.parent&&typeof e.parent=="object"?"globalIdField"in e.parent:"globalIdField"in e)}function qe(e){return!!e&&typeof e=="object"&&"sourceLayer"in e&&k(e.sourceLayer)}function pe(e,t){var d;const{fieldInfos:n,fieldName:r,preventPlacesFormatting:a,layer:i,timeZone:l}=t,s=me(n,r),o=F(i,r);if(s&&!w(r)){const f=o==null?void 0:o.type,c=(d=s.format)==null?void 0:d.dateFormat;if(f==="date"||f==="date-only"||f==="time-only"||f==="timestamp-offset"||c)return C(e,{format:c,fieldType:f,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:l,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}})}const u=s==null?void 0:s.format;return typeof e=="string"&&w(r)&&u?ye(e,u):typeof(e=fe(e,u))=="string"||e==null||u==null?v(e):h(e,a?{...y(u),minimumFractionDigits:0,maximumFractionDigits:20}:y(u))}function ye(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?b(e,",",", ",t):e.includes(";")?b(e,";","; ",t):e.includes(" ")?b(e," "," ",t):h(Number(e),y(t))}function b(e,t,n,r){return e.trim().split(t).map((a=>h(Number(a),y(r)))).join(n)}function me(e,t){if(e!=null&&e.length&&t)return e.find((n=>{var r;return((r=n.fieldName)==null?void 0:r.toLowerCase())===t.toLowerCase()}))}function be({fieldName:e,graphic:t,layer:n}){if(M(e)||!n||typeof n.getFeatureType!="function")return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const a=n.getFeatureType(t);return a?a.name:null}function ge({fieldName:e,value:t,graphic:n,layer:r}){if(M(e)||!r||typeof r.getFieldDomain!="function")return null;const a=n&&r.getFieldDomain(e,{feature:n,excludeImpliedDomains:H("esri-widget-legacy-field-domain-calculation")});return a&&a.type==="coded-value"?a.getName(t):null}function Re(e,t,n,r){const{creatorField:a,creationDateField:i,editorField:l,editDateField:s}=e;if(!t)return;const o=U(r&&"preferredTimeZone"in r?r.preferredTimeZone:null,!(!r||!("datesInUnknownTimezone"in r))&&!!r.datesInUnknownTimezone,n,N,"date"),u={...N,...o},d=t[s];if(typeof d=="number"){const c=t[l];return{type:"edit",date:T(d,u),user:c}}const f=t[i];if(typeof f=="number"){const c=t[a];return{type:"create",date:T(f,u),user:c}}return null}function ke(e,t){const n=new Map;if(!e)return n;for(const r of e){if(!r.fieldName)continue;const a=q(r.fieldName,t);r.fieldName=a,n.set(a.toLowerCase(),r)}return n}function ve(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)&&r.forEach((a=>{if(a.type==="fields"){const i=a==null?void 0:a.fieldInfos;i&&t.push(...i)}})),t}function je(e){return e.replaceAll(W,(t=>`&#${t.charCodeAt(0)};`))}function v(e){return typeof e=="string"?e.replaceAll(K,'<br class="esri-text-new-line" />'):e}function j(e){var f;const{value:t,fieldName:n,fieldInfos:r,fieldInfoMap:a,layer:i,graphic:l,timeZone:s}=e;if(t==null)return"";const o=ge({fieldName:n,value:t,graphic:l,layer:i});if(o)return o;const u=be({fieldName:n,graphic:l,layer:i});if(u)return u;if(a.get(n.toLowerCase()))return pe(t,{fieldInfos:r||Array.from(a.values()),fieldName:n,layer:i,timeZone:s});const d=(f=i==null?void 0:i.fieldsIndex)==null?void 0:f.get(n);return d&&(G(d)||Q(d))?C(t,{fieldType:d.type,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}}):v(t)}function Me({fieldInfos:e,attributes:t,layer:n,graphic:r,fieldInfoMap:a,relatedInfos:i,timeZone:l}){const s={};return i==null||i.forEach((o=>Te({attributes:s,relatedInfo:o,fieldInfoMap:a,fieldInfos:e,layer:n,timeZone:l}))),t&&Object.keys(t).forEach((o=>{const u=t[o];s[o]=j({fieldName:o,fieldInfos:e,fieldInfoMap:a,layer:n,value:u,graphic:r,timeZone:l})})),s}async function Ie(e,t){var d,f;const{layer:n,graphic:r,outFields:a,objectIds:i,returnGeometry:l,spatialReference:s}=e,o=i[0];if(typeof o!="number"&&typeof o!="string"){const c="Could not query required fields for the specified feature. The feature's ID is invalid.",m={layer:n,graphic:r,objectId:o,requiredFields:a};return I().warn(c,m),null}if(!((f=(d=z(n))==null?void 0:d.operations)!=null&&f.supportsQuery)){const c="The specified layer cannot be queried. The following fields will not be available.",m={layer:n,graphic:r,requiredFields:a,returnGeometry:l};return I().warn(c,m),null}const u=n.createQuery();return u.objectIds=i,u.outFields=a!=null&&a.length?a:[n.objectIdField],u.returnGeometry=!!l,u.returnZ=!!l,u.returnM=!!l,u.outSpatialReference=s,(await n.queryFeatures(u,t)).features[0]}async function he(e){var r;if(!((r=e.expressionInfos)!=null&&r.length))return!1;const t=await P(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}async function $e({graphic:e,popupTemplate:t,layer:n,spatialReference:r},a){if(!n||!t||(typeof n.load=="function"&&await n.load(a),!e.attributes))return;const i=n.objectIdField,l=e.attributes[i];if(l==null)return;const s=[l],o=await t.getRequiredFields(n.fieldsIndex),u=O(e,o),d=u?[]:o.includes(i)?o:[...o,i],f=t.returnGeometry||await he(t);if(u&&!f)return;const c=await Ie({layer:n,graphic:e,outFields:d,objectIds:s,returnGeometry:f,spatialReference:r},a);c&&(c.geometry&&(e.geometry=c.geometry),c.attributes&&(e.attributes={...e.attributes,...c.attributes}))}function M(e=""){return!!e&&e.includes(Z)}function Fe(e){return e?`${Z}${e.layerId}/${e.fieldName}`:""}function L({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:a,layer:i,timeZone:l}){e&&t&&n&&Object.keys(t.attributes).forEach((s=>{const o=Fe({layerId:n.relation.id.toString(),fieldName:s}),u=t.attributes[s];e[o]=j({fieldName:o,fieldInfos:r,fieldInfoMap:a,layer:i,value:u,graphic:t,timeZone:l})}))}function Te({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i}){var l,s;e&&t&&((l=t.relatedFeatures)==null||l.forEach((o=>L({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i}))),(s=t.relatedStatsFeatures)==null||s.forEach((o=>L({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i}))))}const x=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},$=({layer:e,method:t,query:n,definitionExpression:r})=>{var l,s;if(!((s=(l=e.capabilities)==null?void 0:l.query)!=null&&s.supportsCacheHint)||t==="attachments")return;const a=n.where!=null?n.where:null,i=n.geometry!=null?n.geometry:null;x(r)||x(a)||(i==null?void 0:i.type)==="extent"||n.resultType==="tile"||(n.cacheHint=!0)},Ue=({query:e,layer:t,method:n})=>{$({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},De=({queryPayload:e,layer:t,method:n})=>{$({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function Se(e,t,n){var r,a;return e&&t&&n?t.type==="sublayer"?p({layers:(r=t.layer)==null?void 0:r.allSublayers,map:e,relatedLayer:t,relationship:n})||p({layers:(a=t.layer)==null?void 0:a.subtables,map:e,relatedLayer:t,relationship:n}):p({layers:e.allLayers,map:e,relatedLayer:t,relationship:n})||p({layers:e.allTables,map:e,relatedLayer:t,relationship:n}):null}function ze(e,t){var n;return e&&"utilityNetworks"in e&&t?(n=e.utilityNetworks)==null?void 0:n.find((r=>r.isUtilityLayer(t))):null}function A(e,t){return e==null?void 0:e.allTables.find((n=>{var r;return n.type==="feature"&&n.layerId===t.id&&n.url===((r=t.layer)==null?void 0:r.url)}))}function p({map:e,relationship:t,relationship:{relatedTableId:n},relatedLayer:r,layers:a}){var i;if(!a)return null;for(const l of a){if(l.type==="map-image"){const o=p({layers:l.sublayers,map:e,relatedLayer:r,relationship:t})||p({layers:l.subtables,map:e,relatedLayer:r,relationship:t});if(o)return o;continue}if(!k(l))continue;if(r.type==="sublayer"){if(l!==r&&l.id===n)return l.isTable?A(e,l):l;continue}const s=r.type==="scene"&&r.associatedLayer?r.associatedLayer.url:r.url;if(!s)return null;if(l.type!=="sublayer"){if(l!==r&&l.url===s&&l.layerId===n)return l}else if(l!==r&&((i=l.layer)==null?void 0:i.url)===s&&l.id===n)return l.isTable?A(e,l):l}return null}export{v as applyTextFormattingHTML,ke as createFieldInfoMap,Se as findRelatedLayer,ze as findUtilityNetwork,se as fixTokens,Me as formatAttributes,Re as formatEditInfo,pe as formatValueToFieldInfo,ve as getAllFieldInfos,me as getFieldInfo,Ae as getFieldInfoLabel,q as getFixedFieldName,Ce as getFixedFieldNames,Ne as getSourceLayer,Le as graphicCallback,je as htmlEntities,Ze as isAssociatedFeatureSupportedLayer,ee as isExpressionField,ce as isFeatureSupportedLayer,qe as isGraphicForRelatableFeatureSupportedLayer,k as isRelatableFeatureSupportedLayer,de as isRelatableLayer,M as isRelatedField,Ue as preLayerQueryCallback,De as preRequestCallback,Ie as querySourceLayer,$e as queryUpdatedFeature,xe as shouldOpenInNewTab,ie as substituteAttributes,Ee as substituteFieldsInLinksAndAttributes};
